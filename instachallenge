<div id="insta-challenge">
  <h2>Insta-Challenge</h2>
  
  <!-- Добавление участников -->
  <div>
    <input type="text" id="newPlayer" placeholder="Имя участника">
    <button onclick="addPlayer()">Добавить участника</button>
  </div>
  <ul id="playerList"></ul>
  
  <hr>
  
  <!-- Ввод минут за день -->
  <div>
    <h3>Добавить день</h3>
    <button onclick="addDay()">Создать день</button>
    <div id="dayInputs"></div>
  </div>
  
  <hr>
  
  <!-- Текущий счёт -->
  <div>
    <h3>Текущие баллы</h3>
    <ul id="scoreList"></ul>
  </div>
  
  <hr>
  
  <button onclick="finishChallenge()">Закончить челлендж</button>
  <div id="finalResult"></div>
</div>

<script>
let players = []; // {name: string, score: int}
let days = [];    // каждый день: { playerName: minutes }

function addPlayer() {
  const name = document.getElementById('newPlayer').value.trim();
  if (!name) return;
  if (players.find(p => p.name === name)) { alert("Такой участник уже есть"); return; }
  players.push({name: name, score: 0});
  updatePlayerList();
  document.getElementById('newPlayer').value = '';
}

function updatePlayerList() {
  const ul = document.getElementById('playerList');
  ul.innerHTML = '';
  players.forEach(p => {
    const li = document.createElement('li');
    li.textContent = p.name;
    ul.appendChild(li);
  });
}

function addDay() {
  if (players.length === 0) { alert("Добавьте участников"); return; }
  
  const dayDiv = document.createElement('div');
  const dayIndex = days.length;
  dayDiv.id = 'day'+dayIndex;
  dayDiv.innerHTML = `<h4>День ${dayIndex + 1}</h4>`;
  
  players.forEach(p => {
    const input = document.createElement('input');
    input.type = 'number';
    input.min = 0;
    input.placeholder = p.name + " (мин)";
    input.id = `day${dayIndex}_player_${p.name}`;
    dayDiv.appendChild(input);
    dayDiv.appendChild(document.createElement('br'));
  });
  
  const submitBtn = document.createElement('button');
  submitBtn.textContent = 'Подтвердить день';
  submitBtn.onclick = () => submitDay(dayIndex);
  dayDiv.appendChild(submitBtn);
  
  document.getElementById('dayInputs').appendChild(dayDiv);
}

function submitDay(dayIndex) {
  let dayData = {};
  let allFilled = true;
  
  players.forEach(p => {
    const val = parseInt(document.getElementById(`day${dayIndex}_player_${p.name}`).value);
    if (isNaN(val)) allFilled = false;
    dayData[p.name] = val;
  });
  
  if (!allFilled) { alert("Заполните все поля"); return; }
  
  days.push(dayData);
  
  // Определяем победителей дня (минимум минут)
  const minMinutes = Math.min(...Object.values(dayData));
  const winners = Object.entries(dayData)
                        .filter(([name, mins]) => mins === minMinutes)
                        .map(([name]) => name);
  
  // Начисляем +1 балл каждому победителю дня
  winners.forEach(name => {
    players.find(p => p.name === name).score += 1;
  });
  
  if (winners.length === 1) {
    alert(`Победитель дня: ${winners[0]}`);
  } else {
    alert(`Победители дня: ${winners.join(', ')}`);
  }
  
  updateScoreList();
  document.getElementById(`day${dayIndex}`).querySelectorAll('input, button').forEach(el => el.disabled = true);
}

function updateScoreList() {
  const ul = document.getElementById('scoreList');
  ul.innerHTML = '';
  players.forEach(p => {
    const li = document.createElement('li');
    li.textContent = `${p.name}: ${p.score} баллов`;
    ul.appendChild(li);
  });
}

function finishChallenge() {
  if (players.length === 0) return;
  
  // Победитель
  const maxScore = Math.max(...players.map(p => p.score));
  const winner = players.find(p => p.score === maxScore);
  
  const prize = winner.score * 100;
  
  // Расчёт выплат по обратной пропорции
  const losers = players.filter(p => p.name !== winner.name);
  const weights = losers.map(p => 1 / (p.score || 1)); // если 0 баллов → вес =1
  const sumWeights = weights.reduce((a,b)=>a+b, 0);
  
  let resultHTML = `<h3>Финальный результат</h3>`;
  resultHTML += `<p>Победитель: <b>${winner.name}</b> — ${winner.score} баллов, приз ${prize} ₽</p>`;
  resultHTML += `<h4>Выплаты проигравших:</h4><ul>`;
  
  losers.forEach((p,i) => {
    const share = Math.round(prize * weights[i]/sumWeights);
    resultHTML += `<li>${p.name} платит: ${share} ₽</li>`;
  });
  
  resultHTML += `</ul>`;
  
  document.getElementById('finalResult').innerHTML = resultHTML;
}
</script>
