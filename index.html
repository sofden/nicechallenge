<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Insta-Challenge</title>
  <style>
    :root { --bg:#0b0c10; --card:#151821; --text:#e8ecf1; --muted:#9aa3af; --accent:#4fd1c5; --border:#232734; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:960px;margin:40px auto;padding:0 16px}
    .card{background:var(--card);border-radius:16px;padding:20px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    h2,h3{margin:0 0 12px}
    hr{border:0;height:1px;background:var(--border);margin:16px 0}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    input[type="text"],input[type="number"],input[type="date"]{
      background:#0f1320;color:var(--text);border:1px solid #2a3042;border-radius:10px;padding:10px 12px;outline:none
    }
    input[type="number"]{width:140px}
    button{background:var(--accent);color:#062e2b;border:0;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:600;transition:transform .05s ease}
    button:disabled{opacity:.6;cursor:not-allowed}
    button:active{transform:translateY(1px)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;background:#0f1320;border:1px solid #2a3042;border-radius:999px;margin:4px 6px 0 0;white-space:nowrap}
    .pill.small{padding:4px 8px;font-size:12px}
    .muted{color:var(--muted)}
    .danger{color:#f38ba8;font-weight:700}
    .winner{color:#a6e3a1;font-weight:700}
    .leader{display:flex;flex-wrap:wrap;gap:8px}
    .days-bar{display:flex;gap:8px;overflow:auto;padding-bottom:4px}
    .days-bar::-webkit-scrollbar{height:6px}
    .days-bar::-webkit-scrollbar-thumb{background:#2a3042;border-radius:999px}
    .active{outline:2px solid var(--accent)}
    .grid{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;max-width:560px}
    .spacer{flex:1}
    .note{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Insta-Challenge</h2>
      <p class="muted">Каждое утро участники вводят минуты. Минимум → +1 балл (при ничьей — всем по баллу). В финале — выплаты по обратной пропорции.</p>

      <!-- ЛИДЕРБОРД СВЕРХУ -->
      <h3>Текущие баллы</h3>
      <div id="scoreList" class="leader muted" style="margin-bottom:8px"></div>

      <hr>

      <!-- УЧАСТНИКИ -->
      <h3>Участники</h3>
      <div class="row" style="margin-bottom:8px">
        <input type="text" id="newPlayer" placeholder="Имя участника" />
        <button onclick="addPlayer()">Добавить</button>
        <button onclick="clearPlayers()" title="Удалить всех участников (сохранив дни)">Очистить участников</button>
        <span class="spacer"></span>
        <button onclick="resetAll()" title="Полный сброс всего">Полный сброс</button>
      </div>
      <div id="playerList" class="row"></div>
      <p class="note">Участники и данные сохраняются локально (в вашем браузере).</p>

      <hr>

      <!-- ДНИ -->
      <h3>Дни</h3>
      <div class="row" style="margin-bottom:8px">
        <input type="date" id="dayPicker" />
        <button onclick="createOrOpenDay()">Открыть / создать день</button>
        <button onclick="gotoPrevDay()">← Предыдущий</button>
        <button onclick="gotoNextDay()">Следующий →</button>
        <span class="spacer"></span>
        <span class="note">Дни не копятся визуально: редактируется только выбранная дата. Ниже — компактная лента.</span>
      </div>

      <!-- ЛЕНТА ДНЕЙ -->
      <div id="daysBar" class="days-bar" style="margin-bottom:12px"></div>

      <!-- ПАНЕЛЬ ВЫБРАННОГО ДНЯ -->
      <div id="dayPanel">
        <div class="row" style="margin-bottom:6px">
          <strong id="dayTitle">День не выбран</strong>
          <span id="dayBadge" class="pill small muted">—</span>
        </div>
        <div id="inputsGrid" class="grid"></div>
        <div class="row" style="margin-top:10px">
          <button id="submitBtn" onclick="submitActiveDay()" disabled>Подтвердить день</button>
          <button id="editBtn" onclick="enableEditActiveDay()" disabled>Редактировать день</button>
        </div>
      </div>

      <hr>

      <div class="row">
        <button onclick="finishChallenge()">Закончить челлендж</button>
      </div>
      <div id="finalResult" style="margin-top:12px"></div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'instaChallenge.v4'; // bump версия для чистого запуска

    let state = {
      players: [], // [{name, score}]
      // days: { [isoDate]: { data: { [playerName]: number|null }, submitted: boolean, winners: string[], _submitting?: boolean } }
      days: {},
      activeDate: null
    };

    // utils
    const $ = s => document.querySelector(s);
    const iso = d => d instanceof Date ? d.toISOString().slice(0,10) : String(d || '').slice(0,10);
    const todayISO = () => iso(new Date());
    const fmtDate = isod => {
      if (!isod) return '';
      const dt = new Date(isod+'T00:00:00');
      return dt.toLocaleDateString('ru-RU', { day:'2-digit', month:'2-digit', year:'numeric', weekday:'short' });
    };
    const save = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    const load = () => { try { const v = JSON.parse(localStorage.getItem(STORAGE_KEY)); if (v && typeof v==='object') state = v; } catch(e){} };

    load();
    renderAll();
    if (!$('#dayPicker').value) $('#dayPicker').value = state.activeDate || todayISO();

    // renderers
    function renderAll() {
      renderPlayers();
      renderScores();
      renderDaysBar();
      renderActiveDayPanel();
    }

    function renderPlayers() {
      const box = $('#playerList');
      box.innerHTML = '';
      state.players.forEach(p => {
        const tag = document.createElement('span');
        tag.className = 'pill';
        tag.textContent = p.name;
        box.appendChild(tag);
      });
    }

    function renderScores() {
      const box = $('#scoreList');
      box.innerHTML = '';
      state.players.slice().sort((a,b)=> b.score - a.score || a.name.localeCompare(b.name))
        .forEach(p => {
          const chip = document.createElement('span');
          chip.className = 'pill';
          chip.textContent = `${p.name}: ${p.score}`;
          box.appendChild(chip);
        });
    }

    function renderDaysBar() {
      const bar = $('#daysBar');
      bar.innerHTML = '';
      const dates = Object.keys(state.days).sort();
      dates.forEach(d => {
        const chip = document.createElement('button');
        chip.className = 'pill small';
        chip.textContent = d;
        chip.onclick = () => { state.activeDate = d; save(); renderAll(); };
        if (state.activeDate === d) chip.classList.add('active');
        const badge = document.createElement('span');
        badge.className = 'note';
        badge.textContent = state.days[d].submitted ? '✓' : '•';
        chip.appendChild(badge);
        bar.appendChild(chip);
      });
    }

    function renderActiveDayPanel() {
      const title = $('#dayTitle');
      const badge = $('#dayBadge');
      const grid = $('#inputsGrid');
      const submitBtn = $('#submitBtn');
      const editBtn = $('#editBtn');

      grid.innerHTML = '';
      submitBtn.disabled = true;
      editBtn.disabled = true;

      if (!state.activeDate || !state.days[state.activeDate]) {
        title.textContent = 'День не выбран';
        badge.textContent = '—';
        badge.className = 'pill small muted';
        return;
      }

      const obj = state.days[state.activeDate];
      title.textContent = `${fmtDate(state.activeDate)} (${state.activeDate})`;

      if (obj.submitted) {
        badge.textContent = obj.winners?.length ? `победители: ${obj.winners.join(', ')}` : 'подтверждён';
        badge.className = 'pill small';
      } else {
        badge.textContent = 'не подтверждён';
        badge.className = 'pill small muted';
      }

      state.players.forEach(p => {
        const label = document.createElement('div');
        label.textContent = p.name;

        const cell = document.createElement('div');
        if (obj.submitted) {
          const chip = document.createElement('span');
          chip.className = 'pill';
          chip.textContent = `${obj.data[p.name] ?? 0} мин`;
          cell.appendChild(chip);
        } else {
          const input = document.createElement('input');
          input.type = 'number';
          input.min = '0';
          input.placeholder = 'минуты';
          input.value = obj.data[p.name] ?? '';
          input.oninput = e => {
            const v = e.target.value === '' ? null : parseInt(e.target.value, 10);
            obj.data[p.name] = Number.isFinite(v) ? v : null;
            save();
          };
          cell.appendChild(input);
        }
        grid.appendChild(label);
        grid.appendChild(cell);
      });

      if (obj.submitted) {
        editBtn.disabled = false;
      } else {
        submitBtn.disabled = false;
      }
    }

    // participants
    function addPlayer() {
      const el = $('#newPlayer');
      const name = (el.value || '').trim();
      if (!name) return;
      if (state.players.find(p => p.name.toLowerCase() === name.toLowerCase())) { alert('Такой участник уже есть'); return; }
      state.players.push({ name, score: 0 });
      // sync with existing days
      Object.values(state.days).forEach(day => {
        if (!(name in day.data)) day.data[name] = day.submitted ? 0 : null;
      });
      el.value = '';
      save();
      renderAll();
    }

    function clearPlayers() {
      if (!confirm('Удалить всех участников? Дни сохранятся, но их данные обнулятся.')) return;
      state.players = [];
      Object.values(state.days).forEach(day => {
        day.data = {};
        day.winners = [];
        day.submitted = false;
        delete day._submitting;
      });
      save();
      renderAll();
    }

    function resetAll() {
      if (!confirm('Полный сброс: участники, дни, баллы — ВСЁ будет удалено. Продолжить?')) return;
      state = { players: [], days: {}, activeDate: null };
      save();
      renderAll();
    }

    // days
    function createOrOpenDay() {
      if (state.players.length === 0) { alert('Добавьте участников'); return; }
      const dp = $('#dayPicker');
      let d = dp.value || todayISO();
      dp.value = d;

      if (!state.days[d]) {
        const data = {};
        state.players.forEach(p => data[p.name] = null);
        state.days[d] = { data, submitted:false, winners:[] };
      }
      state.activeDate = d;
      save();
      renderAll();
    }

    function gotoPrevDay() {
      const keys = Object.keys(state.days).sort();
      if (!keys.length) return;
      const idx = Math.max(0, keys.indexOf(state.activeDate));
      const prev = keys[idx-1] ?? keys[0];
      state.activeDate = prev;
      $('#dayPicker').value = prev;
      save(); renderAll();
    }

    function gotoNextDay() {
      const keys = Object.keys(state.days).sort();
      if (!keys.length) return;
      const idx = Math.max(0, keys.indexOf(state.activeDate));
      const next = keys[idx+1] ?? keys[keys.length-1];
      state.activeDate = next;
      $('#dayPicker').value = next;
      save(); renderAll();
    }

    // NEW: редактура дня — откат начисленных баллов и перевод в режим редактирования
    function enableEditActiveDay() {
      const d = state.activeDate;
      if (!d) return;
      const obj = state.days[d];
      if (!obj) return;
      if (!obj.submitted) return; // и так редактируется

      // Откатываем баллы, начисленные за этот день
      if (Array.isArray(obj.winners)) {
        obj.winners.forEach(name => {
          const pl = state.players.find(p => p.name === name);
          if (pl) pl.score = Math.max(0, (pl.score || 0) - 1);
        });
      }

      // Сбрасываем статус дня
      obj.submitted = false;
      obj.winners = [];
      delete obj._submitting;

      save();
      renderScores();
      renderActiveDayPanel(); // теперь кнопка "Подтвердить" снова активна
      renderDaysBar();
    }

    // защита от повторных подтверждений: ставим флаг и блокируем кнопку сразу
    function submitActiveDay() {
      const btn = $('#submitBtn');
      btn.disabled = true; // мгновенно блокируем от повторных кликов

      const d = state.activeDate;
      if (!d) return;
      const obj = state.days[d];
      if (!obj) return;

      if (obj._submitting) return;           // защита от многократных вызовов
      if (obj.submitted) return;             // уже подтверждён — нечего делать
      obj._submitting = true;

      // Проверяем заполнение
      let ok = true;
      state.players.forEach(p => {
        const v = obj.data[p.name];
        if (v === null || Number.isNaN(v)) ok = false;
      });
      if (!ok) {
        alert('Заполните минуты для всех участников');
        obj._submitting = false;
        btn.disabled = false; // вернуть возможность после исправления
        return;
      }

      // Находим победителей
      const vals = Object.values(obj.data);
      const minV = Math.min(...vals);
      const winners = Object.entries(obj.data).filter(([,v]) => v === minV).map(([name]) => name);

      // Начисляем баллы
      winners.forEach(n => {
        const pl = state.players.find(p => p.name === n);
        if (pl) pl.score += 1;
      });

      obj.submitted = true;
      obj.winners = winners;
      obj._submitting = false;

      save();

      alert(winners.length===1
        ? `Победитель дня (${fmtDate(d)}): ${winners[0]}`
        : `Победители дня (${fmtDate(d)}): ${winners.join(', ')}`);

      renderScores();
      renderActiveDayPanel(); // здесь "Подтвердить" станет disabled, "Редактировать" — enabled
      renderDaysBar();
    }

    // finish / payouts
    function finishChallenge() {
      if (!state.players.length) return;
      const maxScore = Math.max(...state.players.map(p => p.score));
      const top = state.players.filter(p => p.score === maxScore);
      const firstWinner = top[0];
      const prize = firstWinner.score * 100;

      const losers = state.players.filter(p => !top.includes(p));
      let html = `<h3>Финальный результат</h3>`;

      if (top.length === 1) {
        html += `<p>Победитель: <span class="winner">${firstWinner.name}</span> — ${firstWinner.score} баллов. Приз: <b>${prize} ₽</b></p>`;
      } else {
        const names = top.map(p=>p.name).join(', ');
        html += `<p>Победители: <span class="winner">${names}</span> — по ${maxScore} баллов.</p>`;
        html += `<p class="note">Ниже выплаты рассчитаны по призу первого победителя: <b>${prize} ₽</b> (правило можно изменить).</p>`;
      }

      if (!losers.length) {
        html += `<p class="muted">Проигравших нет — никто не платит 🙂</p>`;
        $('#finalResult').innerHTML = html;
        return;
      }

      const weights = losers.map(p => 1 / (p.score || 1));
      const sumW = weights.reduce((a,b)=>a+b, 0);

      html += `<h4>Выплаты проигравших</h4><ul>`;
      losers.forEach((p,i) => {
        const pay = Math.round(prize * (weights[i]/sumW));
        html += `<li><span class="danger">${p.name}</span> платит: <b>${pay} ₽</b> (баллы: ${p.score})</li>`;
      });
      html += `</ul>`;

      $('#finalResult').innerHTML = html;
    }
  </script>
</body>
</html>
