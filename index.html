<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Insta-Challenge</title>
  <style>
    :root { --bg:#0b0c10; --card:#151821; --text:#e8ecf1; --muted:#9aa3af; --accent:#4fd1c5; --border:#232734; }
    *{box-sizing:border-box}
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width:900px; margin:40px auto; padding:0 16px; }
    .card { background:var(--card); border-radius:16px; padding:20px; box-shadow:0 6px 24px rgba(0,0,0,.25); }
    h2,h3{margin:0 0 12px}
    hr{border:0;height:1px;background:var(--border);margin:16px 0}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    input[type="text"],input[type="number"],input[type="date"]{
      background:#0f1320;color:var(--text);border:1px solid #2a3042;border-radius:10px;padding:10px 12px;outline:none
    }
    input[type="number"]{width:140px}
    button{
      background:var(--accent);color:#062e2b;border:0;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:600;transition:transform .05s ease
    }
    button:active{transform:translateY(1px)}
    .pill{display:inline-block;padding:6px 10px;background:#0f1320;border:1px solid #2a3042;border-radius:999px;margin:4px 6px 0 0}
    .muted{color:var(--muted)}
    .danger{color:#f38ba8;font-weight:700}
    .winner{color:#a6e3a1;font-weight:700}
    .days{display:grid;gap:10px}
    details{
      border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#0f1320
    }
    summary{list-style:none;padding:10px 14px;cursor:pointer;display:flex;align-items:center;gap:10px}
    summary::-webkit-details-marker{display:none}
    .badge{background:#22283a;border:1px solid #2a3042;border-radius:999px;padding:4px 8px;font-size:12px;color:var(--muted)}
    .panel{padding:12px 14px;border-top:1px solid var(--border)}
    .inputs-grid{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;max-width:520px}
    .top-actions{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .footer-note{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Insta-Challenge</h2>
      <p class="muted">Каждое утро участники вводят минуты. Минимальное время за день даёт +1 балл (если ничья — всем по баллу). В финале считаем победителя и выплаты.</p>

      <!-- Участники -->
      <h3>Участники</h3>
      <div class="row top-actions">
        <input type="text" id="newPlayer" placeholder="Имя участника" />
        <button onclick="addPlayer()">Добавить</button>
        <button onclick="resetAll()" title="Очистить всё">Сбросить</button>
      </div>
      <div id="playerList" class="row"></div>

      <hr>

      <!-- Дни -->
      <h3>Дни</h3>
      <div class="row top-actions">
        <input type="date" id="dayPicker" />
        <button onclick="addOrOpenDay()">Добавить / открыть день</button>
        <span class="footer-note">Дни показываются свернутыми. Нельзя добавить один и тот же день дважды.</span>
      </div>

      <div id="daysContainer" class="days"></div>

      <hr>

      <!-- Счёт -->
      <h3>Текущие баллы</h3>
      <div id="scoreList" class="row muted"></div>

      <hr>

      <div class="row">
        <button onclick="finishChallenge()">Закончить челлендж</button>
      </div>
      <div id="finalResult" style="margin-top:12px;"></div>
    </div>
  </div>

  <script>
    // --- state ---
    let players = []; // {name, score}
    // days: Map by ISO date -> { date, data: { [playerName]: minutes|null }, submitted: boolean, winners?: string[] }
    const days = new Map();

    // --- helpers ---
    const $ = sel => document.querySelector(sel);
    const iso = d => d instanceof Date ? d.toISOString().slice(0,10) : String(d);
    const fmtDate = isod => {
      const dt = new Date(isod+'T00:00:00');
      return dt.toLocaleDateString('ru-RU', { day:'2-digit', month:'2-digit', year:'numeric', weekday:'short' });
    };

    // --- participants ---
    function addPlayer() {
      const el = $('#newPlayer');
      const name = (el.value || '').trim();
      if (!name) return;
      if (players.find(p => p.name === name)) { alert('Такой участник уже есть'); return; }
      players.push({ name, score: 0 });
      el.value = '';
      renderPlayers();
      renderScores();
      // Если есть уже созданные дни — добавим пустые поля для нового участника
      days.forEach((dayObj, key) => {
        dayObj.data[name] = dayObj.submitted ? (dayObj.data[name] ?? 0) : null;
        refreshDayUI(key);
      });
    }

    function resetAll() {
      if (!confirm('Точно сбросить участников, дни и баллы?')) return;
      players = [];
      days.clear();
      $('#playerList').innerHTML = '';
      $('#daysContainer').innerHTML = '';
      $('#scoreList').innerHTML = '';
      $('#finalResult').innerHTML = '';
    }

    function renderPlayers() {
      const box = $('#playerList');
      box.innerHTML = '';
      players.forEach(p => {
        const span = document.createElement('span');
        span.className = 'pill';
        span.textContent = p.name;
        box.appendChild(span);
      });
    }

    function renderScores() {
      const box = $('#scoreList');
      box.innerHTML = '';
      players
        .slice()
        .sort((a,b)=> b.score - a.score || a.name.localeCompare(b.name))
        .forEach(p => {
          const span = document.createElement('span');
          span.className = 'pill';
          span.textContent = `${p.name}: ${p.score}`;
          box.appendChild(span);
        });
    }

    // --- days / calendar ---
    function addOrOpenDay() {
      if (players.length === 0) { alert('Добавьте участников'); return; }
      const picker = $('#dayPicker');
      let d = picker.value;
      if (!d) {
        // по умолчанию сегодня
        d = iso(new Date());
        picker.value = d;
      }
      if (!days.has(d)) {
        // создать новый день (пока пустые минуты)
        const data = {};
        players.forEach(p => data[p.name] = null);
        days.set(d, { date: d, data, submitted: false, winners: [] });
        createDayUI(d);
      }
      // раскрыть существующий
      const det = document.querySelector(`details[data-date="${d}"]`);
      if (det) det.open = true;
    }

    function createDayUI(isodate) {
      const container = $('#daysContainer');

      // создаём карточку дня
      const details = document.createElement('details');
      details.dataset.date = isodate;

      const summary = document.createElement('summary');
      summary.innerHTML = `
        <strong>${fmtDate(isodate)}</strong>
        <span class="badge" id="badge-${isodate}">не подтверждён</span>
      `;
      details.appendChild(summary);

      const panel = document.createElement('div');
      panel.className = 'panel';

      const grid = document.createElement('div');
      grid.className = 'inputs-grid';
      grid.id = `grid-${isodate}`;
      panel.appendChild(grid);

      const actions = document.createElement('div');
      actions.className = 'row';
      const btn = document.createElement('button');
      btn.textContent = 'Подтвердить день';
      btn.onclick = () => submitDay(isodate);
      actions.appendChild(btn);
      panel.appendChild(actions);

      details.appendChild(panel);

      // вставляем по дате, чтобы список был отсортирован (свежие сверху)
      const all = Array.from(container.children);
      const insertIdx = all.findIndex(el => (el.dataset.date || '') < isodate); // ISO сортируется лексикографически
      if (insertIdx === -1) container.appendChild(details);
      else container.insertBefore(details, all[insertIdx]);

      refreshDayUI(isodate);
    }

    function refreshDayUI(isodate) {
      const dayObj = days.get(isodate);
      const grid = $(`#grid-${isodate}`);
      const badge = $(`#badge-${isodate}`);
      grid.innerHTML = '';

      players.forEach(p => {
        const label = document.createElement('div');
        label.textContent = p.name;

        const inputWrap = document.createElement('div');
        if (!dayObj.submitted) {
          const input = document.createElement('input');
          input.type = 'number';
          input.min = '0';
          input.placeholder = 'минуты';
          input.value = dayObj.data[p.name] ?? '';
          input.oninput = e => {
            const val = e.target.value === '' ? null : parseInt(e.target.value, 10);
            dayObj.data[p.name] = Number.isFinite(val) ? val : null;
          };
          inputWrap.appendChild(input);
        } else {
          const pill = document.createElement('span');
          pill.className = 'pill';
          const v = dayObj.data[p.name];
          pill.textContent = `${v} мин`;
          inputWrap.appendChild(pill);
        }

        grid.appendChild(label);
        grid.appendChild(inputWrap);
      });

      if (!dayObj.submitted) {
        badge.textContent = 'не подтверждён';
      } else {
        const w = dayObj.winners || [];
        badge.textContent = w.length ? `победители: ${w.join(', ')}` : 'подтверждён';
      }
    }

    function submitDay(isodate) {
      const dayObj = days.get(isodate);
      if (!dayObj) return;

      // проверяем, что все поля заполнены числами
      let allFilled = true;
      players.forEach(p => {
        const v = dayObj.data[p.name];
        if (v === null || Number.isNaN(v)) allFilled = false;
      });
      if (!allFilled) { alert('Заполните минуты для всех участников'); return; }

      // считаем победителей (минимум)
      const values = Object.values(dayObj.data);
      const minMinutes = Math.min(...values);
      const winners = Object.entries(dayObj.data)
        .filter(([, mins]) => mins === minMinutes)
        .map(([name]) => name);

      winners.forEach(name => {
        const pl = players.find(p => p.name === name);
        if (pl) pl.score += 1;
      });

      dayObj.submitted = true;
      dayObj.winners = winners;

      alert(winners.length === 1
        ? `Победитель дня (${fmtDate(isodate)}): ${winners[0]}`
        : `Победители дня (${fmtDate(isodate)}): ${winners.join(', ')}`);

      renderScores();
      refreshDayUI(isodate);
    }

    // --- finish ---
    function finishChallenge() {
      if (players.length === 0) return;

      const maxScore = Math.max(...players.map(p => p.score));
      const top = players.filter(p => p.score === maxScore);
      const winnerNames = top.map(p => p.name).join(', ');
      const firstWinner = top[0];
      const prize = firstWinner.score * 100;

      const losers = players.filter(p => !top.includes(p));
      let html = `<h3>Финальный результат</h3>`;

      if (top.length === 1) {
        html += `<p>Победитель: <span class="winner">${firstWinner.name}</span> — ${firstWinner.score} баллов. Приз: <b>${prize} ₽</b></p>`;
      } else {
        html += `<p>Победители: <span class="winner">${winnerNames}</span> — по ${maxScore} баллов.</p>`;
        html += `<p class="muted">Для расчёта выплат ниже используется приз, рассчитанный по первому победителю: <b>${prize} ₽</b> (при необходимости можно изменить правило).</p>`;
      }

      if (losers.length === 0) {
        html += `<p class="muted">Проигравших нет — никто не платит 🙂</p>`;
        $('#finalResult').innerHTML = html;
        return;
      }

      // обратная пропорция (вес = 1 / score; если 0 → вес = 1)
      const weights = losers.map(p => 1 / (p.score || 1));
      const sumW = weights.reduce((a,b)=>a+b, 0);

      html += `<h4>Выплаты проигравших</h4><ul>`;
      losers.forEach((p,i) => {
        const pay = Math.round(prize * (weights[i]/sumW));
        html += `<li><span class="danger">${p.name}</span> платит: <b>${pay} ₽</b> (баллы: ${p.score})</li>`;
      });
      html += `</ul>`;

      $('#finalResult').innerHTML = html;
    }
  </script>
</body>
</html>
