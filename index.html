<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Insta-Challenge</title>
  <style>
    :root { --bg:#0b0c10; --card:#151821; --text:#e8ecf1; --muted:#9aa3af; --accent:#4fd1c5; --border:#232734; }
    *{box-sizing:border-box}
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif; background:var(--bg); color:var(--text); }
    .wrap { max-width:900px; margin:40px auto; padding:0 16px; }
    .card { background:var(--card); border-radius:16px; padding:20px; box-shadow:0 6px 24px rgba(0,0,0,.25); }
    h2,h3{margin:0 0 12px}
    hr{border:0;height:1px;background:var(--border);margin:16px 0}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    input[type="text"],input[type="number"],input[type="date"]{
      background:#0f1320;color:var(--text);border:1px solid #2a3042;border-radius:10px;padding:10px 12px;outline:none
    }
    input[type="number"]{width:140px}
    button{
      background:var(--accent);color:#062e2b;border:0;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:600;transition:transform .05s ease
    }
    button:active{transform:translateY(1px)}
    .pill{display:inline-block;padding:6px 10px;background:#0f1320;border:1px solid #2a3042;border-radius:999px;margin:4px 6px 0 0}
    .muted{color:var(--muted)}
    .danger{color:#f38ba8;font-weight:700}
    .winner{color:#a6e3a1;font-weight:700}
    .days{display:grid;gap:10px}
    details{
      border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#0f1320
    }
    summary{list-style:none;padding:10px 14px;cursor:pointer;display:flex;align-items:center;gap:10px}
    summary::-webkit-details-marker{display:none}
    .badge{background:#22283a;border:1px solid #2a3042;border-radius:999px;padding:4px 8px;font-size:12px;color:var(--muted)}
    .panel{padding:12px 14px;border-top:1px solid var(--border)}
    .inputs-grid{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;max-width:520px}
    .top-actions{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .footer-note{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Insta-Challenge</h2>
      <p class="muted">–ö–∞–∂–¥–æ–µ —É—Ç—Ä–æ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –≤–≤–æ–¥—è—Ç –º–∏–Ω—É—Ç—ã. –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –∑–∞ –¥–µ–Ω—å –¥–∞—ë—Ç +1 –±–∞–ª–ª (–µ—Å–ª–∏ –Ω–∏—á—å—è ‚Äî –≤—Å–µ–º –ø–æ –±–∞–ª–ª—É). –í —Ñ–∏–Ω–∞–ª–µ —Å—á–∏—Ç–∞–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è –∏ –≤—ã–ø–ª–∞—Ç—ã.</p>

      <!-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ -->
      <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
      <div class="row top-actions">
        <input type="text" id="newPlayer" placeholder="–ò–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞" />
        <button onclick="addPlayer()">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button onclick="resetAll()" title="–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë">–°–±—Ä–æ—Å–∏—Ç—å</button>
      </div>
      <div id="playerList" class="row"></div>

      <hr>

      <!-- –î–Ω–∏ -->
      <h3>–î–Ω–∏</h3>
      <div class="row top-actions">
        <input type="date" id="dayPicker" />
        <button onclick="addOrOpenDay()">–î–æ–±–∞–≤–∏—Ç—å / –æ—Ç–∫—Ä—ã—Ç—å –¥–µ–Ω—å</button>
        <span class="footer-note">–î–Ω–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Å–≤–µ—Ä–Ω—É—Ç—ã–º–∏. –ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –¥–µ–Ω—å –¥–≤–∞–∂–¥—ã.</span>
      </div>

      <div id="daysContainer" class="days"></div>

      <hr>

      <!-- –°—á—ë—Ç -->
      <h3>–¢–µ–∫—É—â–∏–µ –±–∞–ª–ª—ã</h3>
      <div id="scoreList" class="row muted"></div>

      <hr>

      <div class="row">
        <button onclick="finishChallenge()">–ó–∞–∫–æ–Ω—á–∏—Ç—å —á–µ–ª–ª–µ–Ω–¥–∂</button>
      </div>
      <div id="finalResult" style="margin-top:12px;"></div>
    </div>
  </div>

  <script>
    // --- state ---
    let players = []; // {name, score}
    // days: Map by ISO date -> { date, data: { [playerName]: minutes|null }, submitted: boolean, winners?: string[] }
    const days = new Map();

    // --- helpers ---
    const $ = sel => document.querySelector(sel);
    const iso = d => d instanceof Date ? d.toISOString().slice(0,10) : String(d);
    const fmtDate = isod => {
      const dt = new Date(isod+'T00:00:00');
      return dt.toLocaleDateString('ru-RU', { day:'2-digit', month:'2-digit', year:'numeric', weekday:'short' });
    };

    // --- participants ---
    function addPlayer() {
      const el = $('#newPlayer');
      const name = (el.value || '').trim();
      if (!name) return;
      if (players.find(p => p.name === name)) { alert('–¢–∞–∫–æ–π —É—á–∞—Å—Ç–Ω–∏–∫ —É–∂–µ –µ—Å—Ç—å'); return; }
      players.push({ name, score: 0 });
      el.value = '';
      renderPlayers();
      renderScores();
      // –ï—Å–ª–∏ –µ—Å—Ç—å —É–∂–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –¥–Ω–∏ ‚Äî –¥–æ–±–∞–≤–∏–º –ø—É—Å—Ç—ã–µ –ø–æ–ª—è –¥–ª—è –Ω–æ–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
      days.forEach((dayObj, key) => {
        dayObj.data[name] = dayObj.submitted ? (dayObj.data[name] ?? 0) : null;
        refreshDayUI(key);
      });
    }

    function resetAll() {
      if (!confirm('–¢–æ—á–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤, –¥–Ω–∏ –∏ –±–∞–ª–ª—ã?')) return;
      players = [];
      days.clear();
      $('#playerList').innerHTML = '';
      $('#daysContainer').innerHTML = '';
      $('#scoreList').innerHTML = '';
      $('#finalResult').innerHTML = '';
    }

    function renderPlayers() {
      const box = $('#playerList');
      box.innerHTML = '';
      players.forEach(p => {
        const span = document.createElement('span');
        span.className = 'pill';
        span.textContent = p.name;
        box.appendChild(span);
      });
    }

    function renderScores() {
      const box = $('#scoreList');
      box.innerHTML = '';
      players
        .slice()
        .sort((a,b)=> b.score - a.score || a.name.localeCompare(b.name))
        .forEach(p => {
          const span = document.createElement('span');
          span.className = 'pill';
          span.textContent = `${p.name}: ${p.score}`;
          box.appendChild(span);
        });
    }

    // --- days / calendar ---
    function addOrOpenDay() {
      if (players.length === 0) { alert('–î–æ–±–∞–≤—å—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤'); return; }
      const picker = $('#dayPicker');
      let d = picker.value;
      if (!d) {
        // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–µ–≥–æ–¥–Ω—è
        d = iso(new Date());
        picker.value = d;
      }
      if (!days.has(d)) {
        // —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –¥–µ–Ω—å (–ø–æ–∫–∞ –ø—É—Å—Ç—ã–µ –º–∏–Ω—É—Ç—ã)
        const data = {};
        players.forEach(p => data[p.name] = null);
        days.set(d, { date: d, data, submitted: false, winners: [] });
        createDayUI(d);
      }
      // —Ä–∞—Å–∫—Ä—ã—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π
      const det = document.querySelector(`details[data-date="${d}"]`);
      if (det) det.open = true;
    }

    function createDayUI(isodate) {
      const container = $('#daysContainer');

      // —Å–æ–∑–¥–∞—ë–º –∫–∞—Ä—Ç–æ—á–∫—É –¥–Ω—è
      const details = document.createElement('details');
      details.dataset.date = isodate;

      const summary = document.createElement('summary');
      summary.innerHTML = `
        <strong>${fmtDate(isodate)}</strong>
        <span class="badge" id="badge-${isodate}">–Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω</span>
      `;
      details.appendChild(summary);

      const panel = document.createElement('div');
      panel.className = 'panel';

      const grid = document.createElement('div');
      grid.className = 'inputs-grid';
      grid.id = `grid-${isodate}`;
      panel.appendChild(grid);

      const actions = document.createElement('div');
      actions.className = 'row';
      const btn = document.createElement('button');
      btn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–µ–Ω—å';
      btn.onclick = () => submitDay(isodate);
      actions.appendChild(btn);
      panel.appendChild(actions);

      details.appendChild(panel);

      // –≤—Å—Ç–∞–≤–ª—è–µ–º –ø–æ –¥–∞—Ç–µ, —á—Ç–æ–±—ã —Å–ø–∏—Å–æ–∫ –±—ã–ª –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω (—Å–≤–µ–∂–∏–µ —Å–≤–µ—Ä—Ö—É)
      const all = Array.from(container.children);
      const insertIdx = all.findIndex(el => (el.dataset.date || '') < isodate); // ISO —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –ª–µ–∫—Å–∏–∫–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏
      if (insertIdx === -1) container.appendChild(details);
      else container.insertBefore(details, all[insertIdx]);

      refreshDayUI(isodate);
    }

    function refreshDayUI(isodate) {
      const dayObj = days.get(isodate);
      const grid = $(`#grid-${isodate}`);
      const badge = $(`#badge-${isodate}`);
      grid.innerHTML = '';

      players.forEach(p => {
        const label = document.createElement('div');
        label.textContent = p.name;

        const inputWrap = document.createElement('div');
        if (!dayObj.submitted) {
          const input = document.createElement('input');
          input.type = 'number';
          input.min = '0';
          input.placeholder = '–º–∏–Ω—É—Ç—ã';
          input.value = dayObj.data[p.name] ?? '';
          input.oninput = e => {
            const val = e.target.value === '' ? null : parseInt(e.target.value, 10);
            dayObj.data[p.name] = Number.isFinite(val) ? val : null;
          };
          inputWrap.appendChild(input);
        } else {
          const pill = document.createElement('span');
          pill.className = 'pill';
          const v = dayObj.data[p.name];
          pill.textContent = `${v} –º–∏–Ω`;
          inputWrap.appendChild(pill);
        }

        grid.appendChild(label);
        grid.appendChild(inputWrap);
      });

      if (!dayObj.submitted) {
        badge.textContent = '–Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω';
      } else {
        const w = dayObj.winners || [];
        badge.textContent = w.length ? `–ø–æ–±–µ–¥–∏—Ç–µ–ª–∏: ${w.join(', ')}` : '–ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω';
      }
    }

    function submitDay(isodate) {
      const dayObj = days.get(isodate);
      if (!dayObj) return;

      // –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã —á–∏—Å–ª–∞–º–∏
      let allFilled = true;
      players.forEach(p => {
        const v = dayObj.data[p.name];
        if (v === null || Number.isNaN(v)) allFilled = false;
      });
      if (!allFilled) { alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –º–∏–Ω—É—Ç—ã –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤'); return; }

      // —Å—á–∏—Ç–∞–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π (–º–∏–Ω–∏–º—É–º)
      const values = Object.values(dayObj.data);
      const minMinutes = Math.min(...values);
      const winners = Object.entries(dayObj.data)
        .filter(([, mins]) => mins === minMinutes)
        .map(([name]) => name);

      winners.forEach(name => {
        const pl = players.find(p => p.name === name);
        if (pl) pl.score += 1;
      });

      dayObj.submitted = true;
      dayObj.winners = winners;

      alert(winners.length === 1
        ? `–ü–æ–±–µ–¥–∏—Ç–µ–ª—å –¥–Ω—è (${fmtDate(isodate)}): ${winners[0]}`
        : `–ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ –¥–Ω—è (${fmtDate(isodate)}): ${winners.join(', ')}`);

      renderScores();
      refreshDayUI(isodate);
    }

    // --- finish ---
    function finishChallenge() {
      if (players.length === 0) return;

      const maxScore = Math.max(...players.map(p => p.score));
      const top = players.filter(p => p.score === maxScore);
      const winnerNames = top.map(p => p.name).join(', ');
      const firstWinner = top[0];
      const prize = firstWinner.score * 100;

      const losers = players.filter(p => !top.includes(p));
      let html = `<h3>–§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</h3>`;

      if (top.length === 1) {
        html += `<p>–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: <span class="winner">${firstWinner.name}</span> ‚Äî ${firstWinner.score} –±–∞–ª–ª–æ–≤. –ü—Ä–∏–∑: <b>${prize} ‚ÇΩ</b></p>`;
      } else {
        html += `<p>–ü–æ–±–µ–¥–∏—Ç–µ–ª–∏: <span class="winner">${winnerNames}</span> ‚Äî –ø–æ ${maxScore} –±–∞–ª–ª–æ–≤.</p>`;
        html += `<p class="muted">–î–ª—è —Ä–∞—Å—á—ë—Ç–∞ –≤—ã–ø–ª–∞—Ç –Ω–∏–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏–∑, —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–π –ø–æ –ø–µ—Ä–≤–æ–º—É –ø–æ–±–µ–¥–∏—Ç–µ–ª—é: <b>${prize} ‚ÇΩ</b> (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ).</p>`;
      }

      if (losers.length === 0) {
        html += `<p class="muted">–ü—Ä–æ–∏–≥—Ä–∞–≤—à–∏—Ö –Ω–µ—Ç ‚Äî –Ω–∏–∫—Ç–æ –Ω–µ –ø–ª–∞—Ç–∏—Ç üôÇ</p>`;
        $('#finalResult').innerHTML = html;
        return;
      }

      // –æ–±—Ä–∞—Ç–Ω–∞—è –ø—Ä–æ–ø–æ—Ä—Ü–∏—è (–≤–µ—Å = 1 / score; –µ—Å–ª–∏ 0 ‚Üí –≤–µ—Å = 1)
      const weights = losers.map(p => 1 / (p.score || 1));
      const sumW = weights.reduce((a,b)=>a+b, 0);

      html += `<h4>–í—ã–ø–ª–∞—Ç—ã –ø—Ä–æ–∏–≥—Ä–∞–≤—à–∏—Ö</h4><ul>`;
      losers.forEach((p,i) => {
        const pay = Math.round(prize * (weights[i]/sumW));
        html += `<li><span class="danger">${p.name}</span> –ø–ª–∞—Ç–∏—Ç: <b>${pay} ‚ÇΩ</b> (–±–∞–ª–ª—ã: ${p.score})</li>`;
      });
      html += `</ul>`;

      $('#finalResult').innerHTML = html;
    }
  </script>
</body>
</html>
