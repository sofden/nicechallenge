<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Insta-Challenge</title>
  <style>
    :root { --bg:#0b0c10; --card:#151821; --text:#e8ecf1; --muted:#9aa3af; --accent:#4fd1c5; --border:#232734; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:960px;margin:40px auto;padding:0 16px}
    .card{background:var(--card);border-radius:16px;padding:20px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    h2,h3{margin:0 0 12px}
    hr{border:0;height:1px;background:var(--border);margin:16px 0}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    input[type="text"],input[type="number"],input[type="date"]{
      background:#0f1320;color:var(--text);border:1px solid #2a3042;border-radius:10px;padding:10px 12px;outline:none
    }
    input[type="number"]{width:140px}
    button{background:var(--accent);color:#062e2b;border:0;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:600;transition:transform .05s ease}
    button:disabled{opacity:.6;cursor:not-allowed}
    button:active{transform:translateY(1px)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;background:#0f1320;border:1px solid #2a3042;border-radius:999px;margin:4px 6px 0 0;white-space:nowrap}
    .pill.small{padding:4px 8px;font-size:12px}
    .muted{color:var(--muted)}
    .danger{color:#f38ba8;font-weight:700}
    .winner{color:#a6e3a1;font-weight:700}
    .leader{display:flex;flex-wrap:wrap;gap:8px}
    .days-bar{display:flex;gap:8px;overflow:auto;padding-bottom:4px}
    .days-bar::-webkit-scrollbar{height:6px}
    .days-bar::-webkit-scrollbar-thumb{background:#2a3042;border-radius:999px}
    .active{outline:2px solid var(--accent)}
    .grid{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;max-width:560px}
    .spacer{flex:1}
    .note{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Insta-Challenge</h2>
      <p class="muted">–ö–∞–∂–¥–æ–µ —É—Ç—Ä–æ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –≤–≤–æ–¥—è—Ç –º–∏–Ω—É—Ç—ã. –ú–∏–Ω–∏–º—É–º ‚Üí +1 –±–∞–ª–ª (–ø—Ä–∏ –Ω–∏—á—å–µ–π ‚Äî –≤—Å–µ–º –ø–æ –±–∞–ª–ª—É). –í —Ñ–∏–Ω–∞–ª–µ ‚Äî –≤—ã–ø–ª–∞—Ç—ã –ø–æ –æ–±—Ä–∞—Ç–Ω–æ–π –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏.</p>

      <!-- –õ–ò–î–ï–†–ë–û–†–î –°–í–ï–†–•–£ -->
      <h3>–¢–µ–∫—É—â–∏–µ –±–∞–ª–ª—ã</h3>
      <div id="scoreList" class="leader muted" style="margin-bottom:8px"></div>

      <hr>

      <!-- –£–ß–ê–°–¢–ù–ò–ö–ò -->
      <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
      <div class="row" style="margin-bottom:8px">
        <input type="text" id="newPlayer" placeholder="–ò–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞" />
        <button onclick="addPlayer()">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button onclick="clearPlayers()" title="–£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (—Å–æ—Ö—Ä–∞–Ω–∏–≤ –¥–Ω–∏)">–û—á–∏—Å—Ç–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</button>
        <span class="spacer"></span>
        <button onclick="resetAll()" title="–ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –≤—Å–µ–≥–æ">–ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å</button>
      </div>
      <div id="playerList" class="row"></div>
      <p class="note">–£—á–∞—Å—Ç–Ω–∏–∫–∏ –∏ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (–≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ).</p>

      <hr>

      <!-- –î–ù–ò -->
      <h3>–î–Ω–∏</h3>
      <div class="row" style="margin-bottom:8px">
        <input type="date" id="dayPicker" />
        <button onclick="createOrOpenDay()">–û—Ç–∫—Ä—ã—Ç—å / —Å–æ–∑–¥–∞—Ç—å –¥–µ–Ω—å</button>
        <button onclick="gotoPrevDay()">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∏–π</button>
        <button onclick="gotoNextDay()">–°–ª–µ–¥—É—é—â–∏–π ‚Üí</button>
        <span class="spacer"></span>
        <span class="note">–î–Ω–∏ –Ω–µ –∫–æ–ø—è—Ç—Å—è –≤–∏–∑—É–∞–ª—å–Ω–æ: —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞. –ù–∏–∂–µ ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è –ª–µ–Ω—Ç–∞.</span>
      </div>

      <!-- –õ–ï–ù–¢–ê –î–ù–ï–ô -->
      <div id="daysBar" class="days-bar" style="margin-bottom:12px"></div>

      <!-- –ü–ê–ù–ï–õ–¨ –í–´–ë–†–ê–ù–ù–û–ì–û –î–ù–Ø -->
      <div id="dayPanel">
        <div class="row" style="margin-bottom:6px">
          <strong id="dayTitle">–î–µ–Ω—å –Ω–µ –≤—ã–±—Ä–∞–Ω</strong>
          <span id="dayBadge" class="pill small muted">‚Äî</span>
        </div>
        <div id="inputsGrid" class="grid"></div>
        <div class="row" style="margin-top:10px">
          <button id="submitBtn" onclick="submitActiveDay()" disabled>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–µ–Ω—å</button>
          <button id="editBtn" onclick="enableEditActiveDay()" disabled>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–µ–Ω—å</button>
        </div>
      </div>

      <hr>

      <div class="row">
        <button onclick="finishChallenge()">–ó–∞–∫–æ–Ω—á–∏—Ç—å —á–µ–ª–ª–µ–Ω–¥–∂</button>
      </div>
      <div id="finalResult" style="margin-top:12px"></div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'instaChallenge.v4'; // bump –≤–µ—Ä—Å–∏—è –¥–ª—è —á–∏—Å—Ç–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

    let state = {
      players: [], // [{name, score}]
      // days: { [isoDate]: { data: { [playerName]: number|null }, submitted: boolean, winners: string[], _submitting?: boolean } }
      days: {},
      activeDate: null
    };

    // utils
    const $ = s => document.querySelector(s);
    const iso = d => d instanceof Date ? d.toISOString().slice(0,10) : String(d || '').slice(0,10);
    const todayISO = () => iso(new Date());
    const fmtDate = isod => {
      if (!isod) return '';
      const dt = new Date(isod+'T00:00:00');
      return dt.toLocaleDateString('ru-RU', { day:'2-digit', month:'2-digit', year:'numeric', weekday:'short' });
    };
    const save = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    const load = () => { try { const v = JSON.parse(localStorage.getItem(STORAGE_KEY)); if (v && typeof v==='object') state = v; } catch(e){} };

    load();
    renderAll();
    if (!$('#dayPicker').value) $('#dayPicker').value = state.activeDate || todayISO();

    // renderers
    function renderAll() {
      renderPlayers();
      renderScores();
      renderDaysBar();
      renderActiveDayPanel();
    }

    function renderPlayers() {
      const box = $('#playerList');
      box.innerHTML = '';
      state.players.forEach(p => {
        const tag = document.createElement('span');
        tag.className = 'pill';
        tag.textContent = p.name;
        box.appendChild(tag);
      });
    }

    function renderScores() {
      const box = $('#scoreList');
      box.innerHTML = '';
      state.players.slice().sort((a,b)=> b.score - a.score || a.name.localeCompare(b.name))
        .forEach(p => {
          const chip = document.createElement('span');
          chip.className = 'pill';
          chip.textContent = `${p.name}: ${p.score}`;
          box.appendChild(chip);
        });
    }

    function renderDaysBar() {
      const bar = $('#daysBar');
      bar.innerHTML = '';
      const dates = Object.keys(state.days).sort();
      dates.forEach(d => {
        const chip = document.createElement('button');
        chip.className = 'pill small';
        chip.textContent = d;
        chip.onclick = () => { state.activeDate = d; save(); renderAll(); };
        if (state.activeDate === d) chip.classList.add('active');
        const badge = document.createElement('span');
        badge.className = 'note';
        badge.textContent = state.days[d].submitted ? '‚úì' : '‚Ä¢';
        chip.appendChild(badge);
        bar.appendChild(chip);
      });
    }

    function renderActiveDayPanel() {
      const title = $('#dayTitle');
      const badge = $('#dayBadge');
      const grid = $('#inputsGrid');
      const submitBtn = $('#submitBtn');
      const editBtn = $('#editBtn');

      grid.innerHTML = '';
      submitBtn.disabled = true;
      editBtn.disabled = true;

      if (!state.activeDate || !state.days[state.activeDate]) {
        title.textContent = '–î–µ–Ω—å –Ω–µ –≤—ã–±—Ä–∞–Ω';
        badge.textContent = '‚Äî';
        badge.className = 'pill small muted';
        return;
      }

      const obj = state.days[state.activeDate];
      title.textContent = `${fmtDate(state.activeDate)} (${state.activeDate})`;

      if (obj.submitted) {
        badge.textContent = obj.winners?.length ? `–ø–æ–±–µ–¥–∏—Ç–µ–ª–∏: ${obj.winners.join(', ')}` : '–ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω';
        badge.className = 'pill small';
      } else {
        badge.textContent = '–Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω';
        badge.className = 'pill small muted';
      }

      state.players.forEach(p => {
        const label = document.createElement('div');
        label.textContent = p.name;

        const cell = document.createElement('div');
        if (obj.submitted) {
          const chip = document.createElement('span');
          chip.className = 'pill';
          chip.textContent = `${obj.data[p.name] ?? 0} –º–∏–Ω`;
          cell.appendChild(chip);
        } else {
          const input = document.createElement('input');
          input.type = 'number';
          input.min = '0';
          input.placeholder = '–º–∏–Ω—É—Ç—ã';
          input.value = obj.data[p.name] ?? '';
          input.oninput = e => {
            const v = e.target.value === '' ? null : parseInt(e.target.value, 10);
            obj.data[p.name] = Number.isFinite(v) ? v : null;
            save();
          };
          cell.appendChild(input);
        }
        grid.appendChild(label);
        grid.appendChild(cell);
      });

      if (obj.submitted) {
        editBtn.disabled = false;
      } else {
        submitBtn.disabled = false;
      }
    }

    // participants
    function addPlayer() {
      const el = $('#newPlayer');
      const name = (el.value || '').trim();
      if (!name) return;
      if (state.players.find(p => p.name.toLowerCase() === name.toLowerCase())) { alert('–¢–∞–∫–æ–π —É—á–∞—Å—Ç–Ω–∏–∫ —É–∂–µ –µ—Å—Ç—å'); return; }
      state.players.push({ name, score: 0 });
      // sync with existing days
      Object.values(state.days).forEach(day => {
        if (!(name in day.data)) day.data[name] = day.submitted ? 0 : null;
      });
      el.value = '';
      save();
      renderAll();
    }

    function clearPlayers() {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤? –î–Ω–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è, –Ω–æ –∏—Ö –¥–∞–Ω–Ω—ã–µ –æ–±–Ω—É–ª—è—Ç—Å—è.')) return;
      state.players = [];
      Object.values(state.days).forEach(day => {
        day.data = {};
        day.winners = [];
        day.submitted = false;
        delete day._submitting;
      });
      save();
      renderAll();
    }

    function resetAll() {
      if (!confirm('–ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å: —É—á–∞—Å—Ç–Ω–∏–∫–∏, –¥–Ω–∏, –±–∞–ª–ª—ã ‚Äî –í–°–Å –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) return;
      state = { players: [], days: {}, activeDate: null };
      save();
      renderAll();
    }

    // days
    function createOrOpenDay() {
      if (state.players.length === 0) { alert('–î–æ–±–∞–≤—å—Ç–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤'); return; }
      const dp = $('#dayPicker');
      let d = dp.value || todayISO();
      dp.value = d;

      if (!state.days[d]) {
        const data = {};
        state.players.forEach(p => data[p.name] = null);
        state.days[d] = { data, submitted:false, winners:[] };
      }
      state.activeDate = d;
      save();
      renderAll();
    }

    function gotoPrevDay() {
      const keys = Object.keys(state.days).sort();
      if (!keys.length) return;
      const idx = Math.max(0, keys.indexOf(state.activeDate));
      const prev = keys[idx-1] ?? keys[0];
      state.activeDate = prev;
      $('#dayPicker').value = prev;
      save(); renderAll();
    }

    function gotoNextDay() {
      const keys = Object.keys(state.days).sort();
      if (!keys.length) return;
      const idx = Math.max(0, keys.indexOf(state.activeDate));
      const next = keys[idx+1] ?? keys[keys.length-1];
      state.activeDate = next;
      $('#dayPicker').value = next;
      save(); renderAll();
    }

    // NEW: —Ä–µ–¥–∞–∫—Ç—É—Ä–∞ –¥–Ω—è ‚Äî –æ—Ç–∫–∞—Ç –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã—Ö –±–∞–ª–ª–æ–≤ –∏ –ø–µ—Ä–µ–≤–æ–¥ –≤ —Ä–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    function enableEditActiveDay() {
      const d = state.activeDate;
      if (!d) return;
      const obj = state.days[d];
      if (!obj) return;
      if (!obj.submitted) return; // –∏ —Ç–∞–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è

      // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –±–∞–ª–ª—ã, –Ω–∞—á–∏—Å–ª–µ–Ω–Ω—ã–µ –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å
      if (Array.isArray(obj.winners)) {
        obj.winners.forEach(name => {
          const pl = state.players.find(p => p.name === name);
          if (pl) pl.score = Math.max(0, (pl.score || 0) - 1);
        });
      }

      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –¥–Ω—è
      obj.submitted = false;
      obj.winners = [];
      delete obj._submitting;

      save();
      renderScores();
      renderActiveDayPanel(); // —Ç–µ–ø–µ—Ä—å –∫–Ω–æ–ø–∫–∞ "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å" —Å–Ω–æ–≤–∞ –∞–∫—Ç–∏–≤–Ω–∞
      renderDaysBar();
    }

    // –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–π: —Å—Ç–∞–≤–∏–º —Ñ–ª–∞–≥ –∏ –±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Å—Ä–∞–∑—É
    function submitActiveDay() {
      const btn = $('#submitBtn');
      btn.disabled = true; // –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ–º –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∫–ª–∏–∫–æ–≤

      const d = state.activeDate;
      if (!d) return;
      const obj = state.days[d];
      if (!obj) return;

      if (obj._submitting) return;           // –∑–∞—â–∏—Ç–∞ –æ—Ç –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
      if (obj.submitted) return;             // —É–∂–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω ‚Äî –Ω–µ—á–µ–≥–æ –¥–µ–ª–∞—Ç—å
      obj._submitting = true;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
      let ok = true;
      state.players.forEach(p => {
        const v = obj.data[p.name];
        if (v === null || Number.isNaN(v)) ok = false;
      });
      if (!ok) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –º–∏–Ω—É—Ç—ã –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤');
        obj._submitting = false;
        btn.disabled = false; // –≤–µ—Ä–Ω—É—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        return;
      }

      // –ù–∞—Ö–æ–¥–∏–º –ø–æ–±–µ–¥–∏—Ç–µ–ª–µ–π
      const vals = Object.values(obj.data);
      const minV = Math.min(...vals);
      const winners = Object.entries(obj.data).filter(([,v]) => v === minV).map(([name]) => name);

      // –ù–∞—á–∏—Å–ª—è–µ–º –±–∞–ª–ª—ã
      winners.forEach(n => {
        const pl = state.players.find(p => p.name === n);
        if (pl) pl.score += 1;
      });

      obj.submitted = true;
      obj.winners = winners;
      obj._submitting = false;

      save();

      alert(winners.length===1
        ? `–ü–æ–±–µ–¥–∏—Ç–µ–ª—å –¥–Ω—è (${fmtDate(d)}): ${winners[0]}`
        : `–ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ –¥–Ω—è (${fmtDate(d)}): ${winners.join(', ')}`);

      renderScores();
      renderActiveDayPanel(); // –∑–¥–µ—Å—å "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å" —Å—Ç–∞–Ω–µ—Ç disabled, "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" ‚Äî enabled
      renderDaysBar();
    }

    // finish / payouts
    function finishChallenge() {
      if (!state.players.length) return;
      const maxScore = Math.max(...state.players.map(p => p.score));
      const top = state.players.filter(p => p.score === maxScore);
      const firstWinner = top[0];
      const prize = firstWinner.score * 100;

      const losers = state.players.filter(p => !top.includes(p));
      let html = `<h3>–§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</h3>`;

      if (top.length === 1) {
        html += `<p>–ü–æ–±–µ–¥–∏—Ç–µ–ª—å: <span class="winner">${firstWinner.name}</span> ‚Äî ${firstWinner.score} –±–∞–ª–ª–æ–≤. –ü—Ä–∏–∑: <b>${prize} ‚ÇΩ</b></p>`;
      } else {
        const names = top.map(p=>p.name).join(', ');
        html += `<p>–ü–æ–±–µ–¥–∏—Ç–µ–ª–∏: <span class="winner">${names}</span> ‚Äî –ø–æ ${maxScore} –±–∞–ª–ª–æ–≤.</p>`;
        html += `<p class="note">–ù–∏–∂–µ –≤—ã–ø–ª–∞—Ç—ã —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã –ø–æ –ø—Ä–∏–∑—É –ø–µ—Ä–≤–æ–≥–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è: <b>${prize} ‚ÇΩ</b> (–ø—Ä–∞–≤–∏–ª–æ –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å).</p>`;
      }

      if (!losers.length) {
        html += `<p class="muted">–ü—Ä–æ–∏–≥—Ä–∞–≤—à–∏—Ö –Ω–µ—Ç ‚Äî –Ω–∏–∫—Ç–æ –Ω–µ –ø–ª–∞—Ç–∏—Ç üôÇ</p>`;
        $('#finalResult').innerHTML = html;
        return;
      }

      const weights = losers.map(p => 1 / (p.score || 1));
      const sumW = weights.reduce((a,b)=>a+b, 0);

      html += `<h4>–í—ã–ø–ª–∞—Ç—ã –ø—Ä–æ–∏–≥—Ä–∞–≤—à–∏—Ö</h4><ul>`;
      losers.forEach((p,i) => {
        const pay = Math.round(prize * (weights[i]/sumW));
        html += `<li><span class="danger">${p.name}</span> –ø–ª–∞—Ç–∏—Ç: <b>${pay} ‚ÇΩ</b> (–±–∞–ª–ª—ã: ${p.score})</li>`;
      });
      html += `</ul>`;

      $('#finalResult').innerHTML = html;
    }
  </script>
</body>
</html>
