<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Insta-Challenge</title>
  <style>
    :root { --bg:#0b0c10; --card:#151821; --text:#e8ecf1; --muted:#9aa3af; --accent:#4fd1c5; --border:#232734; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:960px;margin:40px auto;padding:0 16px}
    .card{background:var(--card);border-radius:16px;padding:20px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    h2,h3{margin:0 0 12px}
    hr{border:0;height:1px;background:var(--border);margin:16px 0}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    input[type="text"],input[type="number"],input[type="date"]{
      background:#0f1320;color:var(--text);border:1px solid #2a3042;border-radius:10px;padding:10px 12px;outline:none
    }
    input[type="number"]{width:140px}
    button{background:var(--accent);color:#062e2b;border:0;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:600;transition:transform .05s ease}
    button:disabled{opacity:.6;cursor:not-allowed}
    button:active{transform:translateY(1px)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;background:#0f1320;border:1px solid #2a3042;border-radius:999px;margin:4px 6px 0 0;white-space:nowrap}
    .pill.small{padding:4px 8px;font-size:12px}
    .muted{color:var(--muted)}
    .danger{color:#f38ba8;font-weight:700}
    .winner{color:#a6e3a1;font-weight:700}
    .leader{display:flex;flex-wrap:wrap;gap:8px}
    .stats{display:flex;flex-wrap:wrap;gap:8px}
    .days-bar{display:flex;gap:8px;overflow:auto;padding-bottom:4px}
    .days-bar::-webkit-scrollbar{height:6px}
    .days-bar::-webkit-scrollbar-thumb{background:#2a3042;border-radius:999px}
    .active{outline:2px solid var(--accent)}
    .grid{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;max-width:560px}
    .spacer{flex:1}
    .note{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>Insta-Challenge</h2>
      <p class="muted">–ö–∞–∂–¥–æ–µ —É—Ç—Ä–æ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –≤–≤–æ–¥—è—Ç –º–∏–Ω—É—Ç—ã. –ú–∏–Ω–∏–º—É–º ‚Üí +1 –±–∞–ª–ª (–ø—Ä–∏ –Ω–∏—á—å–µ–π ‚Äî –≤—Å–µ–º –ø–æ –±–∞–ª–ª—É). –í —Ñ–∏–Ω–∞–ª–µ ‚Äî –≤—ã–ø–ª–∞—Ç—ã –ø–æ –æ–±—Ä–∞—Ç–Ω–æ–π –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏.</p>

      <!-- –õ–ò–î–ï–†–ë–û–†–î –°–í–ï–†–•–£ -->
      <h3>–¢–µ–∫—É—â–∏–µ –±–∞–ª–ª—ã</h3>
      <div id="scoreList" class="leader muted" style="margin-bottom:8px"></div>

      <!-- –°–†–ï–î–ù–ò–ï –ú–ò–ù–£–¢–´ -->
      <div id="avgBlock" style="margin:6px 0 12px">
        <h3>–°—Ä–µ–¥–Ω–∏–µ –º–∏–Ω—É—Ç—ã</h3>
        <div id="avgList" class="stats"></div>
        <p class="note" id="avgNote"></p>
      </div>

      <hr>

      <!-- –£–ß–ê–°–¢–ù–ò–ö–ò -->
      <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
      <div class="row" style="margin-bottom:8px">
        <input type="text" id="newPlayer" placeholder="–ò–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞" />
        <button onclick="addPlayer()">–î–æ–±–∞–≤–∏—Ç—å</button>
        <button onclick="clearPlayers()" title="–£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (—Å–æ—Ö—Ä–∞–Ω–∏–≤ –¥–Ω–∏)">–û—á–∏—Å—Ç–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</button>
        <span class="spacer"></span>
        <button onclick="resetAll()" title="–ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å –≤—Å–µ–≥–æ">–ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å</button>
      </div>
      <div id="playerList" class="row"></div>
      <p class="note">–£—á–∞—Å—Ç–Ω–∏–∫–∏ –∏ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ (–≤ –≤–∞—à–µ–º –±—Ä–∞—É–∑–µ—Ä–µ).</p>

      <hr>

      <!-- –ù–ê–°–¢–†–û–ô–ö–ò –ß–ï–õ–õ–ï–ù–î–ñ–ê -->
      <h3>–ß–µ–ª–ª–µ–Ω–¥–∂</h3>
      <div class="row" style="margin-bottom:8px">
        <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:&nbsp;<input type="date" id="startPicker" /></label>
        <button onclick="applyStartDate()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞</button>
        <span class="spacer"></span>
        <span class="note">–í—Å–µ –¥–Ω–∏ –æ—Ç –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ –¥–æ —Å–µ–≥–æ–¥–Ω—è —Å–æ–∑–¥–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ü—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –Ω–æ–≤—ã–π –¥–µ–Ω—å —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å–∞–º.</span>
      </div>

      <!-- –î–ù–ò -->
      <div class="row" style="margin-bottom:8px">
        <input type="date" id="dayPicker" />
        <button onclick="openDay()">–û—Ç–∫—Ä—ã—Ç—å –¥–µ–Ω—å</button>
        <button onclick="gotoPrevDay()">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∏–π</button>
        <button onclick="gotoNextDay()">–°–ª–µ–¥—É—é—â–∏–π ‚Üí</button>
        <span class="spacer"></span>
        <span class="note">–î–Ω–∏ –Ω–µ –∫–æ–ø—è—Ç—Å—è –≤–∏–∑—É–∞–ª—å–Ω–æ: —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞. –ù–∏–∂–µ ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è –ª–µ–Ω—Ç–∞.</span>
      </div>

      <!-- –õ–ï–ù–¢–ê –î–ù–ï–ô -->
      <div id="daysBar" class="days-bar" style="margin-bottom:12px"></div>

      <!-- –ü–ê–ù–ï–õ–¨ –í–´–ë–†–ê–ù–ù–û–ì–û –î–ù–Ø -->
      <div id="dayPanel">
        <div class="row" style="margin-bottom:6px">
          <strong id="dayTitle">–î–µ–Ω—å –Ω–µ –≤—ã–±—Ä–∞–Ω</strong>
          <span id="dayBadge" class="pill small muted">‚Äî</span>
        </div>
        <div id="inputsGrid" class="grid"></div>
        <div class="row" style="margin-top:10px">
          <button id="submitBtn" onclick="submitActiveDay()" disabled>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–µ–Ω—å</button>
          <button id="editBtn" onclick="enableEditActiveDay()" disabled>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–µ–Ω—å</button>
        </div>
      </div>

      <hr>

      <div class="row">
        <button onclick="finishChallenge()">–ó–∞–∫–æ–Ω—á–∏—Ç—å —á–µ–ª–ª–µ–Ω–¥–∂</button>
      </div>
      <div id="finalResult" style="margin-top:12px"></div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'instaChallenge.v5';

    let state = {
      players: [], // [{name, score}]
      // days: { [isoDate]: { data: { [playerName]: number|null }, submitted: boolean, winners: string[] } }
      days: {},
      activeDate: null,
      startDate: null
    };

    // utils
    const $ = s => document.querySelector(s);
    const iso = d => d instanceof Date ? d.toISOString().slice(0,10) : String(d || '').slice(0,10);
    const todayISO = () => iso(new Date());
    const fmtDate = isod => {
      if (!isod) return '';
      const dt = new Date(isod+'T00:00:00');
      return dt.toLocaleDateString('ru-RU', { day:'2-digit', month:'2-digit', year:'numeric', weekday:'short' });
    };
    const save = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    const load = () => { try { const v = JSON.parse(localStorage.getItem(STORAGE_KEY)); if (v && typeof v==='object') state = v; } catch(e){} };

    load();

    // init defaults
    if (!state.startDate) state.startDate = todayISO();
    ensureDaysUpToToday(); // –∞–≤—Ç–æ-—Å–æ–∑–¥–∞–Ω–∏–µ –≤—Å–µ—Ö –¥–Ω–µ–π –æ—Ç —Å—Ç–∞—Ä—Ç–∞ –¥–æ —Å–µ–≥–æ–¥–Ω—è
    if (!state.activeDate) state.activeDate = todayISO();

    // set inputs
    const startPicker = $('#startPicker');
    startPicker.value = state.startDate;
    const dayPicker = $('#dayPicker');
    dayPicker.value = state.activeDate;

    renderAll();

    // ---- core day helpers ----
    function ensureDay(d) {
      if (!state.days[d]) {
        const data = {};
        state.players.forEach(p => data[p.name] = null);
        state.days[d] = { data, submitted:false, winners:[] };
      } else {
        // –µ—Å–ª–∏ –¥–æ–±–∞–≤–∏–ª–∏ –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞ ‚Äî –¥–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–º –ø–æ–ª—è
        state.players.forEach(p => {
          if (!(p.name in state.days[d].data)) {
            state.days[d].data[p.name] = state.days[d].submitted ? 0 : null;
          }
        });
      }
    }

    function dateRangeISO(fromISO, toISO) {
      const res = [];
      let d = new Date(fromISO+'T00:00:00');
      const end = new Date(toISO+'T00:00:00');
      while (d <= end) {
        res.push(iso(d));
        d.setDate(d.getDate()+1);
      }
      return res;
    }

    function ensureDaysUpToToday() {
      const start = state.startDate || todayISO();
      const daysList = dateRangeISO(start, todayISO());
      daysList.forEach(ensureDay);
      save();
    }

    // ---- renderers ----
    function renderAll() {
      renderPlayers();
      renderScores();
      renderAverages();
      renderDaysBar();
      renderActiveDayPanel();
    }

    function renderPlayers() {
      const box = $('#playerList');
      box.innerHTML = '';
      state.players.forEach(p => {
        const tag = document.createElement('span');
        tag.className = 'pill';
        tag.textContent = p.name;
        box.appendChild(tag);
      });
    }

    function renderScores() {
      const box = $('#scoreList');
      box.innerHTML = '';
      state.players.slice().sort((a,b)=> b.score - a.score || a.name.localeCompare(b.name))
        .forEach(p => {
          const chip = document.createElement('span');
          chip.className = 'pill';
          chip.textContent = `${p.name}: ${p.score}`;
          box.appendChild(chip);
        });
    }

    function calcAverages() {
      // —Å—á–∏—Ç–∞–µ–º –ø–æ –ü–û–î–¢–í–ï–†–ñ–î–Å–ù–ù–´–ú –¥–Ω—è–º
      const submittedDates = Object.keys(state.days).filter(d => state.days[d].submitted);
      const totals = new Map(); // name -> {sum, count}
      state.players.forEach(p => totals.set(p.name, {sum:0, count:0}));
      submittedDates.forEach(d => {
        const data = state.days[d].data;
        state.players.forEach(p => {
          const v = data[p.name];
          if (Number.isFinite(v)) {
            const t = totals.get(p.name);
            t.sum += v;
            t.count += 1;
          }
        });
      });
      const rows = state.players.map(p => {
        const t = totals.get(p.name);
        const avg = t.count ? t.sum / t.count : 0;
        return { name:p.name, avg, sum:t.sum, count:t.count };
      });
      return { rows, submittedCount: submittedDates.length };
    }

    function renderAverages() {
      const { rows, submittedCount } = calcAverages();
      const list = $('#avgList');
      const note = $('#avgNote');
      list.innerHTML = '';
      rows.forEach(r => {
        const chip = document.createElement('span');
        chip.className = 'pill';
        chip.textContent = `${r.name}: ${r.avg.toFixed(1)} –º–∏–Ω (–∑–∞ ${r.count} –¥–Ω., Œ£ ${r.sum} –º–∏–Ω)`;
        list.appendChild(chip);
      });
      note.textContent = submittedCount
        ? `–°—Ä–µ–¥–Ω–µ–µ —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–º –¥–Ω—è–º: –≤—Å–µ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ ${submittedCount}.`
        : `–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã—Ö –¥–Ω–µ–π ‚Äî —Å—Ä–µ–¥–Ω–∏–µ —Ä–∞–≤–Ω—ã 0.`;
    }

    function renderDaysBar() {
      const bar = $('#daysBar');
      bar.innerHTML = '';
      const dates = Object.keys(state.days).sort();
      dates.forEach(d => {
        const chip = document.createElement('button');
        chip.className = 'pill small';
        chip.textContent = d;
        chip.onclick = () => { state.activeDate = d; $('#dayPicker').value = d; save(); renderAll(); };
        if (state.activeDate === d) chip.classList.add('active');
        const badge = document.createElement('span');
        badge.className = 'note';
        badge.textContent = state.days[d].submitted ? '‚úì' : '‚Ä¢';
        chip.appendChild(badge);
        bar.appendChild(chip);
      });
    }

    function renderActiveDayPanel() {
      const title = $('#dayTitle');
      const badge = $('#dayBadge');
      const grid = $('#inputsGrid');
      const submitBtn = $('#submitBtn');
      const editBtn = $('#editBtn');

      grid.innerHTML = '';
      submitBtn.disabled = true;
      editBtn.disabled = true;

      if (!state.activeDate || !state.days[state.activeDate]) {
        title.textContent = '–î–µ–Ω—å –Ω–µ –≤—ã–±—Ä–∞–Ω';
        badge.textContent = '‚Äî';
        badge.className = 'pill small muted';
        return;
      }

      const obj = state.days[state.activeDate];
      title.textContent = `${fmtDate(state.activeDate)} (${state.activeDate})`;

      if (obj.submitted) {
        badge.textContent = obj.winners?.length ? `–ø–æ–±–µ–¥–∏—Ç–µ–ª–∏: ${obj.winners.join(', ')}` : '–ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω';
        badge.className = 'pill small';
      } else {
        badge.textContent = '–Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω';
        badge.className = 'pill small muted';
      }

      state.players.forEach(p => {
        const label = document.createElement('div');
        label.textContent = p.name;

        const cell = document.createElement('div');
        if (obj.submitted) {
          const chip = document.createElement('span');
          chip.className = 'pill';
          chip.textContent = `${obj.data[p.name] ?? 0} –º–∏–Ω`;
          cell.appendChild(chip);
        } else {
          const input = document.createElement('input');
          input.type = 'number';
          input.min = '0';
          input.placeholder = '–º–∏–Ω—É—Ç—ã';
          input.value = obj.data[p.name] ?? '';
          input.oninput = e => {
            const v = e.target.value === '' ? null : parseInt(e.target.value, 10);
            obj.data[p.name] = Number.isFinite(v) ? v : null;
            save();
          };
          cell.appendChild(input);
        }
        grid.appendChild(label);
        grid.appendChild(cell);
      });

      if (obj.submitted) {
        editBtn.disabled = false;
      } else {
        submitBtn.disabled = false;
      }
    }

    // ---- participants ----
    function addPlayer() {
      const el = $('#newPlayer');
      const name = (el.value || '').trim();
      if (!name) return;
      if (state.players.find(p => p.name.toLowerCase() === name.toLowerCase())) { alert('–¢–∞–∫–æ–π —É—á–∞—Å—Ç–Ω–∏–∫ —É–∂–µ –µ—Å—Ç—å'); return; }
      state.players.push({ name, score: 0 });
      // sync all days
      Object.keys(state.days).forEach(d => {
        const day = state.days[d];
        if (!(name in day.data)) day.data[name] = day.submitted ? 0 : null;
      });
      el.value = '';
      save();
      renderAll();
    }

    function clearPlayers() {
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤? –î–Ω–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—Å—è, –Ω–æ –∏—Ö –¥–∞–Ω–Ω—ã–µ –æ–±–Ω—É–ª—è—Ç—Å—è.')) return;
      state.players = [];
      Object.values(state.days).forEach(day => {
        day.data = {};
        day.winners = [];
        day.submitted = false;
        delete day._submitting;
      });
      save();
      renderAll();
    }

    function resetAll() {
      if (!confirm('–ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å: —É—á–∞—Å—Ç–Ω–∏–∫–∏, –¥–Ω–∏, –±–∞–ª–ª—ã ‚Äî –í–°–Å –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) return;
      state = { players: [], days: {}, activeDate: null, startDate: todayISO() };
      ensureDaysUpToToday();
      save();
      renderAll();
    }

    // ---- challenge settings ----
    function applyStartDate() {
      const val = $('#startPicker').value || todayISO();
      if (val > todayISO()) { alert('–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤ –±—É–¥—É—â–µ–º'); return; }
      state.startDate = val;
      ensureDaysUpToToday();
      // –µ—Å–ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è –¥–∞—Ç–∞ —Ä–∞–Ω—å—à–µ —Å—Ç–∞—Ä—Ç–∞ ‚Äî —Å–¥–≤–∏–Ω–µ–º –Ω–∞ —Å—Ç–∞—Ä—Ç
      if (!state.activeDate || state.activeDate < state.startDate) {
        state.activeDate = state.startDate;
        $('#dayPicker').value = state.activeDate;
      }
      save();
      renderAll();
    }

    // ---- days navigation / open ----
    function openDay() {
      let d = $('#dayPicker').value || todayISO();
      // –∞–≤—Ç–æ-—Å–æ–∑–¥–∞–Ω–∏–µ –¥–Ω—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
      ensureDay(d);
      state.activeDate = d;
      save();
      renderAll();
    }

    function gotoPrevDay() {
      const keys = Object.keys(state.days).sort();
      if (!keys.length) return;
      let idx = keys.indexOf(state.activeDate);
      if (idx <= 0) idx = 0; else idx -= 1;
      state.activeDate = keys[idx];
      $('#dayPicker').value = state.activeDate;
      save(); renderAll();
    }

    function gotoNextDay() {
      // –µ—Å–ª–∏ –¥–≤–∏–∂–µ–º—Å—è –≤–ø–µ—Ä—ë–¥ –∑–∞ —Å–µ–≥–æ–¥–Ω—è ‚Äî —Å–æ–∑–¥–∞–¥–∏–º –Ω–æ–≤—ã–π –¥–µ–Ω—å (—á—Ç–æ–±—ã ¬´–∏–¥—ë—Ç –∫–∞–∂–¥—ã–π –¥–µ–Ω—å¬ª —Ä–∞–±–æ—Ç–∞–ª–æ –ø–æ —Ñ–∞–∫—Ç—É)
      const today = todayISO();
      ensureDaysUpToToday(); // –Ω–∞ –≤—Å—è–∫–∏–π ‚Äî —ç—Ç–æ—Ç –≤—ã–∑–æ–≤ —Å–ª–µ–¥–∏—Ç, —á—Ç–æ –¥–æ today –≤—Å—ë —Å–æ–∑–¥–∞–Ω–æ

      const keys = Object.keys(state.days).sort();
      if (!keys.length) return;
      let idx = keys.indexOf(state.activeDate);
      if (idx < 0) idx = keys.length-1;
      if (idx >= keys.length-1) {
        // –µ—Å–ª–∏ –º—ã –±—ã–ª–∏ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–º (—Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —Å–µ–≥–æ–¥–Ω—è) ‚Äî –æ—Å—Ç–∞—ë–º—Å—è
        state.activeDate = keys[keys.length-1];
      } else {
        state.activeDate = keys[idx+1];
      }
      $('#dayPicker').value = state.activeDate;
      save(); renderAll();
    }

    // ---- edit / submit day ----
    function enableEditActiveDay() {
      const d = state.activeDate;
      if (!d) return;
      const obj = state.days[d];
      if (!obj || !obj.submitted) return;

      // –æ—Ç–∫–∞—Ç –±–∞–ª–ª–æ–≤
      if (Array.isArray(obj.winners)) {
        obj.winners.forEach(name => {
          const pl = state.players.find(p => p.name === name);
          if (pl) pl.score = Math.max(0, (pl.score || 0) - 1);
        });
      }

      obj.submitted = false;
      obj.winners = [];
      delete obj._submitting;

      save();
      renderScores();
      renderAverages();
      renderActiveDayPanel();
      renderDaysBar();
    }

    function submitActiveDay() {
      const btn = $('#submitBtn');
      btn.disabled = true;

      const d = state.activeDate;
      if (!d) return;
      const obj = state.days[d];
      if (!obj) return;

      if (obj._submitting) return;
      if (obj.submitted) return;
      obj._submitting = true;

      // validate
      let ok = true;
      state.players.forEach(p => {
        const v = obj.data[p.name];
        if (v === null || Number.isNaN(v)) ok = false;
      });
      if (!ok) {
        alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –º–∏–Ω—É—Ç—ã –¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤');
        obj._submitting = false;
        btn.disabled = false;
        return;
      }

      // winners (min)
      const vals = Object.values(obj.data);
      const minV = Math.min(...vals);
      const winners = Object.entries(obj.data).filter(([,v]) => v === minV).map(([name]) => name);

      winners.forEach(n => {
        const pl = state.players.find(p => p.name === n);
        if (pl) pl.score += 1;
      });

      obj.submitted = true;
      obj.winners = winners;
      obj._submitting = false;

      save();

      alert(winners.length===1 ? `–ü–æ–±–µ–¥–∏—Ç–µ–ª—å –¥–Ω—è (${fmtDate(d)}): ${winners[0]}`
                               : `–ü–æ–±–µ–¥–∏—Ç–µ–ª–∏ –¥–Ω—è (${fmtDate(d)}): ${winners.join(', ')}`);

      renderScores();
      renderAverages();
      renderActiveDayPanel();
      renderDaysBar();
    }

    // ---- finish / payouts (+ 2-–µ –º–µ—Å—Ç–æ –ø–æ —Å—Ä–µ–¥–Ω–µ–º—É) ----
    function finishChallenge() {
      if (!state.players.length) return;
      // 1) –ü–æ–±–µ–¥–∏—Ç–µ–ª—å –ø–æ –±–∞–ª–ª–∞–º
      const maxScore = Math.max(...state.players.map(p => p.score));
      const top = state.players.filter(p => p.score === maxScore);
      const firstWinner = top[0];
      const prize = firstWinner.score * 100;

      // 2) –í—Ç–æ—Ä–æ–µ –º–µ—Å—Ç–æ –ø–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º—É —Å—Ä–µ–¥–Ω–µ–º—É (—Å—Ä–µ–¥–∏ –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)
      const { rows } = calcAverages();
      const sortedByAvg = rows.slice().sort((a,b)=> a.avg - b.avg || a.name.localeCompare(b.name));
      const bestAvg = sortedByAvg[0]; // –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å—Ä–µ–¥–Ω–∏–π
      const secondPlaceName = bestAvg?.name || null;

      const losers = state.players.filter(p => !top.includes(p));
      let html = `<h3>–§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç</h3>`;

      // –ü–æ–±–µ–¥–∏—Ç–µ–ª—å (–±–∞–ª–ª—ã)
      if (top.length === 1) {
        html += `<p>1 –º–µ—Å—Ç–æ (–ø–æ –±–∞–ª–ª–∞–º): <span class="winner">${firstWinner.name}</span> ‚Äî ${firstWinner.score} –±–∞–ª–ª–æ–≤. –ü—Ä–∏–∑: <b>${prize} ‚ÇΩ</b></p>`;
      } else {
        const names = top.map(p=>p.name).join(', ');
        html += `<p>1 –º–µ—Å—Ç–æ (–ø–æ –±–∞–ª–ª–∞–º): <span class="winner">${names}</span> ‚Äî –ø–æ ${maxScore} –±–∞–ª–ª–æ–≤.</p>`;
        html += `<p class="note">–í—ã–ø–ª–∞—Ç—ã –Ω–∏–∂–µ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã –ø–æ –ø—Ä–∏–∑—É –ø–µ—Ä–≤–æ–≥–æ –ø–æ–±–µ–¥–∏—Ç–µ–ª—è: <b>${prize} ‚ÇΩ</b> (–ø—Ä–∞–≤–∏–ª–æ –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å).</p>`;
      }

      // –í—Ç–æ—Ä–æ–µ –º–µ—Å—Ç–æ (–ø–æ —Å—Ä–µ–¥–Ω–µ–º—É), –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ç–æ—Ç –∂–µ —É—á–∞—Å—Ç–Ω–∏–∫, —á—Ç–æ 1-–µ –º–µ—Å—Ç–æ-–æ–¥–∏–Ω–æ—á–∫–∞
      if (secondPlaceName) {
        const sameAsFirstSolo = (top.length === 1 && secondPlaceName === firstWinner.name);
        if (!sameAsFirstSolo) {
          const r = rows.find(x => x.name === secondPlaceName);
          const avgStr = r ? `${r.avg.toFixed(1)} –º–∏–Ω (–∑–∞ ${r.count} –¥–Ω., Œ£ ${r.sum} –º–∏–Ω)` : '';
          html += `<p>2 –º–µ—Å—Ç–æ (–ø–æ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–º—É —Å—Ä–µ–¥–Ω–µ–º—É): <span class="winner">${secondPlaceName}</span> ‚Äî ${avgStr}. –ü—Ä–∏–∑–∞ –Ω–µ—Ç.</p>`;
        }
      }

      if (!losers.length) {
        html += `<p class="muted">–ü—Ä–æ–∏–≥—Ä–∞–≤—à–∏—Ö –Ω–µ—Ç ‚Äî –Ω–∏–∫—Ç–æ –Ω–µ –ø–ª–∞—Ç–∏—Ç üôÇ</p>`;
        $('#finalResult').innerHTML = html;
        return;
      }

      // –≤—ã–ø–ª–∞—Ç—ã (–æ–±—Ä–∞—Ç–Ω–∞—è –ø—Ä–æ–ø–æ—Ä—Ü–∏—è)
      const weights = losers.map(p => 1 / (p.score || 1));
      const sumW = weights.reduce((a,b)=>a+b, 0);

      html += `<h4>–í—ã–ø–ª–∞—Ç—ã –ø—Ä–æ–∏–≥—Ä–∞–≤—à–∏—Ö</h4><ul>`;
      losers.forEach((p,i) => {
        const pay = Math.round(prize * (weights[i]/sumW));
        html += `<li><span class="danger">${p.name}</span> –ø–ª–∞—Ç–∏—Ç: <b>${pay} ‚ÇΩ</b> (–±–∞–ª–ª—ã: ${p.score})</li>`;
      });
      html += `</ul>`;

      $('#finalResult').innerHTML = html;
    }
  </script>
</body>
</html>
